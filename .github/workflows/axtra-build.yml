name: Axtra Build
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      os_patch_level:
        description: 'OS patch level (YYYY-MM)'
        required: false
        default: ''
      release_type:
        description: 'Release type: Stable (release) or Test (prerelease)'
        required: true
        default: 'test'

jobs:
  build-gki:
    runs-on: ubuntu-latest

    steps:
      - name: Check Initial Disk Space
        run: |
          echo "===== Initial Total Disk Space in GB ====="
          df -BG

      - name: Free up space
        run: |
          curl -L -o util_free_space.sh https://raw.githubusercontent.com/apache/arrow/main/ci/scripts/util_free_space.sh
          chmod +x util_free_space.sh
          ./util_free_space.sh
          df -BG

      - name: Set fixed variables
        run: |
          echo "ANDROID_VERSION=android15" >> $GITHUB_ENV
          echo "KERNEL_VERSION=6.6" >> $GITHUB_ENV
          echo "CONFIG=custom-kernel" >> $GITHUB_ENV

      - name: Resolve OS_PATCH_LEVEL (auto if blank)
        run: |
          OPL="${{ inputs.os_patch_level }}"
          if [ -z "$OPL" ] || [ "$OPL" = "auto" ]; then
            OPL="$(date -u +%Y-%m)"
          fi
          echo "OS_PATCH_LEVEL=$OPL" >> $GITHUB_ENV

      - name: Setup Build Environment
        run: |
          # Install required packages
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libncurses-dev \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            bc \
            git \
            wget \
            curl \
            python3 \
            unzip \
            rsync

          # Clone mkbootimg tools if needed
          git clone https://android.googlesource.com/platform/system/tools/mkbootimg --depth=1

      - name: Clone AnyKernel3
        run: |
          git clone https://github.com/adamspaini/AnyKernel3.git -b axtra

      - name: Clone Custom Kernel Source
        run: |
          mkdir -p "$CONFIG"
          cd "$CONFIG"
          git clone https://github.com/kuonji-arisu/android_kernel_xiaomi_sm8750.git .
          
          # Set up git identity
          git config user.email "ci@github.com"
          git config user.name "GitHub Actions CI"

      - name: Extract Kernel Version
        id: sublevel
        run: |
          cd "$CONFIG"
          VERSION=$(grep -E '^VERSION[[:space:]]*=' Makefile | awk '{print $3}' | tr -d '\n')
          PATCHLEVEL=$(grep -E '^PATCHLEVEL[[:space:]]*=' Makefile | awk '{print $3}' | tr -d '\n')
          SUBLEVEL=$(grep -E '^SUBLEVEL[[:space:]]*=' Makefile | awk '{print $3}' | tr -d '\n')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "PATCHLEVEL=$PATCHLEVEL" >> $GITHUB_ENV
          echo "SUBLEVEL=$SUBLEVEL" >> $GITHUB_ENV
          echo "sublevel=$SUBLEVEL" >> $GITHUB_OUTPUT

      - name: Configure Kernel Features
        run: |
          cd "$CONFIG"
          
          # First find the defconfig file
          DEFCONFIG=""
          if [ -f "arch/arm64/configs/vendor/kona-perf_defconfig" ]; then
            DEFCONFIG="vendor/kona-perf_defconfig"
          elif [ -f "arch/arm64/configs/vendor/sm8250-perf_defconfig" ]; then
            DEFCONFIG="vendor/sm8250-perf_defconfig"
          elif [ -f "arch/arm64/configs/vendor/kona_defconfig" ]; then
            DEFCONFIG="vendor/kona_defconfig"
          else
            # Find any defconfig
            DEFCONFIG=$(find arch/arm64/configs -name "*defconfig" | head -1)
          fi
          
          if [ -z "$DEFCONFIG" ]; then
            echo "Error: No defconfig found!"
            find arch/arm64/configs -type f
            exit 1
          fi
          
          echo "Using defconfig: $DEFCONFIG"
          echo "DEFCONFIG_PATH=$DEFCONFIG" >> $GITHUB_ENV
          
          # Copy defconfig to .config
          cp "arch/arm64/configs/$DEFCONFIG" .config
          
          # Modify .config using menuconfig style
          {
            echo "# Mountify"
            echo "CONFIG_TMPFS_XATTR=y"
            echo "CONFIG_TMPFS_POSIX_ACL=y"

            echo "# Networking"
            echo "CONFIG_IP_NF_TARGET_TTL=y"
            echo "CONFIG_IP6_NF_TARGET_HL=y"
            echo "CONFIG_IP6_NF_MATCH_HL=y"

            echo "# TCP BBR"
            echo "CONFIG_TCP_CONG_ADVANCED=y"
            echo "CONFIG_TCP_CONG_BBR=y"
            echo "CONFIG_NET_SCH_FQ=y"

            echo "# IPSet"
            echo "CONFIG_IP_SET=y"
            echo "CONFIG_IP_SET_MAX=65534"

            echo "# Sound"
            echo "CONFIG_SND=y"
            echo "CONFIG_SND_ALOOP=m"

            echo "# Build Optimization"
            echo "CONFIG_LTO_CLANG_THIN=y"
            echo "CONFIG_LTO_CLANG=y"

            echo "# Branding"
            echo 'CONFIG_LOCALVERSION="-Axtra-GKI-rebornX"'
            echo '# CONFIG_LOCALVERSION_AUTO is not set'
          } >> .config

      - name: Add HymoFS Support
        run: |
          cd "$CONFIG"
          
          echo "Downloading HymoFS patch..."
          wget -q https://raw.githubusercontent.com/Anatdx/HymoFS/refs/heads/main/patch/hymofs.patch
          
          echo "Applying HymoFS patch..."
          # Try to apply patch with different levels
          patch -p1 < hymofs.patch || patch -p0 < hymofs.patch || patch -p2 < hymofs.patch || {
            echo "Patch application may have warnings, continuing..."
          }
          
          # Add HymoFS to config
          echo "CONFIG_HYMOFS=y" >> .config
          
          # Clean up
          rm -f hymofs.patch

      - name: Set Build Information
        run: |
          cd "$CONFIG"
          
          # Set build user and host
          export KBUILD_BUILD_USER="Axtra"
          export KBUILD_BUILD_HOST="CI"
          
          # Add timestamp to localversion
          TIMESTAMP=$(date -u +"%Y%m%d%H%M")
          echo "-Axtra-GKI-$TIMESTAMP" > localversion

      - name: Build Kernel
        run: |
          cd "$CONFIG"
          
          # Set environment variables
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # Install cross-compiler if not present
          if ! command -v aarch64-linux-gnu-gcc &> /dev/null; then
            echo "Installing cross-compiler..."
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          fi
          
          # Clean and configure
          make clean || true
          make mrproper || true
          
          # Use saved config
          cp .config arch/arm64/configs/temp_defconfig
          make temp_defconfig
          
          # Build kernel
          echo "Starting kernel build..."
          make -j$(nproc) Image.gz-dtb 2>&1 | tee build.log || {
            echo "Image.gz-dtb failed, trying Image.gz..."
            make -j$(nproc) Image.gz 2>&1 | tee build.log
          }

      - name: Prepare AnyKernel3 Image
        run: |
          cd "$CONFIG"
          
          # Look for the built kernel image
          KERNEL_IMG=""
          if [ -f "arch/arm64/boot/Image.gz-dtb" ]; then
            KERNEL_IMG="arch/arm64/boot/Image.gz-dtb"
          elif [ -f "arch/arm64/boot/Image.gz" ]; then
            KERNEL_IMG="arch/arm64/boot/Image.gz"
          elif [ -f "arch/arm64/boot/Image" ]; then
            KERNEL_IMG="arch/arm64/boot/Image"
          fi
          
          if [ -z "$KERNEL_IMG" ]; then
            echo "Error: No kernel image found!"
            ls -la arch/arm64/boot/
            exit 1
          fi
          
          echo "Found kernel image: $KERNEL_IMG"
          
          # Copy to AnyKernel3
          cp "$KERNEL_IMG" ../AnyKernel3/Image

      - name: Set release file + tag names
        id: names
        run: |
          DATE=$(date -u +%Y%m%d)
          RAND=$(shuf -i 1000-9999 -n 1)
          FILE_NAME="Axtra-GKI-6.6-${DATE}-${RAND}"
          if [ "${{ inputs.release_type }}" = "release" ]; then
            TAG="v6.6-${DATE}-${RAND}"
            TITLE="Axtra GKI 6.6 (${DATE})"
            MAKE_LATEST="true"
          else
            TAG="test-6.6-${DATE}-${RAND}"
            TITLE="Axtra GKI 6.6 Test (${DATE})"
            MAKE_LATEST="false"
          fi
          echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV
          echo "RELEASE_TITLE=$TITLE" >> $GITHUB_ENV
          echo "MAKE_LATEST=$MAKE_LATEST" >> $GITHUB_ENV

      - name: Package flashable AnyKernel zip
        run: |
          cd AnyKernel3
          
          # Clean up
          rm -rf .git .github || true
          
          # Update anykernel.sh with build info
          if [ -f "anykernel.sh" ]; then
            sed -i "s|kernel.string=.*|kernel.string=Axtra GKI 6.6 built $(date -u +'%Y-%m-%d')|" anykernel.sh
            sed -i "s|do.devicecheck=.*|do.devicecheck=0|" anykernel.sh
            sed -i "s|do.modules=.*|do.modules=0|" anykernel.sh
            sed -i "s|do.cleanup=.*|do.cleanup=1|" anykernel.sh
            sed -i "s|do.cleanuponabort=.*|do.cleanuponabort=0|" anykernel.sh
          fi
          
          # Create zip
          zip -r9 ../${{ env.FILE_NAME }}.zip . -x "*.git*" "*.github*"

      - name: Build Summary
        run: |
          echo "# Kernel Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "## ${{ env.FILE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source:** kuonji-arisu/android_kernel_xiaomi_sm8750" >> $GITHUB_STEP_SUMMARY
          echo "- **Kernel Version:** $VERSION.$PATCHLEVEL.$SUBLEVEL" >> $GITHUB_STEP_SUMMARY
          echo "- **Features:** HymoFS support" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag:** ${{ env.RELEASE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Asset:** ${{ env.FILE_NAME }}.zip" >> $GITHUB_STEP_SUMMARY

      - name: Publish GitHub Release (upload asset)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TITLE }}
          prerelease: ${{ inputs.release_type != 'release' }}
          draft: false
          generate_release_notes: true
          make_latest: ${{ env.MAKE_LATEST }}
          files: |
            ${{ env.FILE_NAME }}.zipwhile read file; do
              echo "Found: $file"
            done
            exit 1
          fi
          
          # Copy to AnyKernel3
          cp "$KERNEL_IMG" ../../AnyKernel3/Image

      - name: Set release file + tag names
        id: names
        run: |
          DATE=$(date -u +%Y%m%d)
          RAND=$(shuf -i 1000-9999 -n 1)
          FILE_NAME="Axtra-GKI-6.6-${DATE}-${RAND}"
          if [ "${{ inputs.release_type }}" = "release" ]; then
            TAG="v6.6-${DATE}-${RAND}"
            TITLE="Axtra GKI 6.6 (${DATE})"
            MAKE_LATEST="true"
          else
            TAG="test-6.6-${DATE}-${RAND}"
            TITLE="Axtra GKI 6.6 Test (${DATE})"
            MAKE_LATEST="false"
          fi
          echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV
          echo "RELEASE_TITLE=$TITLE" >> $GITHUB_ENV
          echo "MAKE_LATEST=$MAKE_LATEST" >> $GITHUB_ENV

      - name: Package flashable AnyKernel zip
        run: |
          cd AnyKernel3
          rm -rf .git .github || true
          
          # Update anykernel.sh with build info
          sed -i "s/kernel.string=.*/kernel.string=Axtra GKI 6.6 built $(date -u +'%Y-%m-%d')/" anykernel.sh
          
          zip -r9 ../${{ env.FILE_NAME }}.zip . -x "*.git*" "*.github*"

      - name: Build Summary
        run: |
          echo "# Kernel Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "## ${{ env.FILE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source:** kuonji-arisu/android_kernel_xiaomi_sm8750" >> $GITHUB_STEP_SUMMARY
          echo "- **Android Version:** android15" >> $GITHUB_STEP_SUMMARY
          echo "- **Kernel:** 6.6.${{ steps.sublevel.outputs.sublevel }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Features:** HymoFS support" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag:** ${{ env.RELEASE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Asset:** ${{ env.FILE_NAME }}.zip" >> $GITHUB_STEP_SUMMARY

      - name: Publish GitHub Release (upload asset)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TITLE }}
          prerelease: ${{ inputs.release_type != 'release' }}
          draft: false
          generate_release_notes: true
          make_latest: ${{ env.MAKE_LATEST }}
          files: |
            ${{ env.FILE_NAME }}.zipAxtra GKI 6.6 Test (${DATE})"
            MAKE_LATEST="false"
          fi
          echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV
          echo "RELEASE_TITLE=$TITLE" >> $GITHUB_ENV
          echo "MAKE_LATEST=$MAKE_LATEST" >> $GITHUB_ENV

      - name: Package flashable AnyKernel zip
        run: |
          cd AnyKernel3
          rm -rf .git .github || true
          zip -r9 ../${{ env.FILE_NAME }}.zip . -x "*.git*" "*.github*"

      - name: Build Summary
        run: |
          echo "# Kernel Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "## ${{ env.FILE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Android Version:** android15" >> $GITHUB_STEP_SUMMARY
          echo "- **Kernel:** 6.6.${{ steps.sublevel.outputs.sublevel }}" >> $GITHUB_STEP_SUMMARY
          echo "- **OS Patch (branch):** $OS_PATCH_LEVEL" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag:** ${{ env.RELEASE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Asset:** ${{ env.FILE_NAME }}.zip" >> $GITHUB_STEP_SUMMARY

      - name: Publish GitHub Release (upload asset)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TITLE }}
          prerelease: ${{ inputs.release_type != 'release' }}
          draft: false
          generate_release_notes: true
          make_latest: ${{ env.MAKE_LATEST }}
          files: |
            ${{ env.FILE_NAME }}.zip
